name: End-to-End Testing

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: iot_network_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
      
      mosquitto:
        image: eclipse-mosquitto
        ports:
          - 1883:1883
          - 9001:9001

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend-services/requirements.txt
      
      - name: Install frontend dependencies
        run: |
          cd web-dashboard
          npm ci
          cd ..
      
      - name: Start backend service
        run: |
          cd backend-services
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/iot_network_test
          REDIS_URL: redis://localhost:6379
      
      - name: Run backend E2E tests
        run: |
          cd backend-services
          pytest tests/test_integration.py -v --tb=short
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/iot_network_test
          REDIS_URL: redis://localhost:6379
          MQTT_BROKER: localhost
      
      - name: Run device firmware tests
        run: |
          cd device-firmware
          platformio test -e test_native --verbose || true
      
      - name: Build frontend
        run: |
          cd web-dashboard
          npm run build
      
      - name: Run frontend E2E tests
        run: |
          cd web-dashboard
          npm run test:e2e || true
      
      - name: Run smart contracts tests
        run: |
          cd smart-contracts
          npm ci
          npx hardhat test
      
      - name: Cleanup
        if: always()
        run: |
          pkill -f "uvicorn" || true
          docker-compose down || true

  workflow-test:
    runs-on: ubuntu-latest
    needs: e2e-tests
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: iot_network_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend-services/requirements.txt
      
      - name: Start backend service
        run: |
          cd backend-services
          uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          sleep 5
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/iot_network_test
          REDIS_URL: redis://localhost:6379
      
      - name: Test Complete Device Workflow
        run: |
          python << 'EOF'
          import requests
          import time
          import json

          BASE_URL = "http://localhost:8000"

          # Test 1: User Registration
          print("Testing user registration...")
          user_data = {
              "email": "testuser@example.com",
              "password": "password123",
              "username": "testuser"
          }
          response = requests.post(f"{BASE_URL}/users/register", json=user_data)
          assert response.status_code in [200, 400], f"User registration failed: {response.status_code}"
          print("✓ User registration passed")

          # Test 2: Device Registration
          print("Testing device registration...")
          device_data = {
              "device_id": "test-device-001",
              "user_id": "test-user-001",
              "signature": "test-signature"
          }
          response = requests.post(f"{BASE_URL}/devices/register", json=device_data)
          assert response.status_code in [200, 400, 409], f"Device registration failed: {response.status_code}"
          print("✓ Device registration passed")

          # Test 3: Device Data Submission
          print("Testing device data submission...")
          submission_data = {
              "device_id": "test-device-001",
              "energy_generated": 150.5,
              "timestamp": "2025-01-01T12:00:00Z"
          }
          response = requests.post(f"{BASE_URL}/devices/submit-data", json=submission_data)
          assert response.status_code in [200, 400, 404], f"Data submission failed: {response.status_code}"
          print("✓ Device data submission passed")

          # Test 4: Device Data Retrieval
          print("Testing device data retrieval...")
          response = requests.get(f"{BASE_URL}/devices/test-device-001/data")
          assert response.status_code in [200, 400, 404], f"Data retrieval failed: {response.status_code}"
          print("✓ Device data retrieval passed")

          # Test 5: Health Check
          print("Testing health check...")
          response = requests.get(f"{BASE_URL}/health")
          assert response.status_code == 200, f"Health check failed: {response.status_code}"
          print("✓ Health check passed")

          print("\n✅ All workflow tests passed!")
          EOF
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/iot_network_test
          REDIS_URL: redis://localhost:6379
      
      - name: Cleanup
        if: always()
        run: |
          pkill -f "uvicorn" || true
